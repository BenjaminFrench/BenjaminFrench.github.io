<html>
    <!-- use version 0.20.1 -->
    <!-- <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script> -->
    <!-- <script src=" https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js "></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/exceljs@1.13.0/dist/exceljs.min.js"></script> -->
    <script src="/excel/exceljs.js"></script>

    <script>
        /* suppress default behavior for drag and drop events */
        function suppress(e) { e.stopPropagation(); e.preventDefault(); }

        /* handle data from drop event */
        async function handleDropAsync(e) {
          var outBook = new ExcelJS.Workbook();
          var worksheets = {};

          suppress(e);
          for (file of e.dataTransfer.files) {
            const data = await file.arrayBuffer();

            const sheetName = file.name.split('.').slice(0, -1).join('.');

            var workbook = new ExcelJS.Workbook();
            workbook.xlsx.load(data).then(function(workbook) {
              worksheets[sheetName] = workbook.worksheets[0];
            });

            // make a FileReader
            //var reader = new FileReader();

            // callback for onloadend
            //reader.onloadend = function(event) {
              //var arrayBuffer = reader.result;

              //var workbook = new ExcelJS.Workbook();

              //workbook.xlsx.load(arrayBuffer).then(function(workbook) {
                //worksheets[sheetName] = workbook.worksheets[0];
              //});
            //};

            //reader.readAsArrayBuffer(file);
          }
          // console.log(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
          // sort the worksheets
          var orderList = [
            'Consolidated Detail',
            'TICKET',
            'SKIRID',
            'RENTAL',
            'FOODBV',
            'SPORTS',
            'CHILD',
            'MISC',
            'AREAM',
            'CALLC',
            'GENADM',
            'GUESER',
            'HOUSE',
            'LIFTMA',
            'LITFOP',
            'MARKET',
            'PARK',
            'SECUR',
            'SKIPAT',
            'SNOWMK',
            'TRAILM',
            'VEHICL',
            'WATER',
          ];

          for (sheetName of orderList) {
            if (!worksheets[sheetName]) {
              // if we don't have it, append blank
              // XLSX.utils.book_append_sheet(outBook, XLSX.utils.json_to_sheet([{}]) , sheetName);
              outBook.addWorksheet(sheetName)
            }
            else {
              // else get from worksheets
              // XLSX.utils.book_append_sheet(outBook, worksheets[sheetName], sheetName);
              let copySheet = outBook.addWorksheet(sheetName);
              //copySheet.model = worksheets[sheetName].model;
              copySheet.model = Object.assign(worksheets[sheetName].model, {
                // @ts-ignore
                mergeCells: worksheets[sheetName].model.merges
              });

              //copySheet.model.merge = worksheets[sheetName].model.merge;
              copySheet.name = sheetName;
            }
          }

          // write output file

          outBook.xlsx.writeBuffer( {
              base64: true
          })
          .then( function (xls64) {
              // build anchor tag and attach file (works in chrome)
              var a = document.createElement("a");
              var data = new Blob([xls64], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

              var url = URL.createObjectURL(data);
              a.href = url;
              a.download = "export.xlsx";
              document.body.appendChild(a);
              a.click();
              setTimeout(function() {
                      document.body.removeChild(a);
                      window.URL.revokeObjectURL(url);
                  },
                  0);
          })
          .catch(function(error) {
              console.log(error.message);
          });

        }

        window.addEventListener("drop", handleDropAsync, false);
        window.addEventListener("dragover", suppress, false);
        window.addEventListener("dragenter", suppress, false);

    </script>
</html>
